<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ficha de Anamnese - Estúdio</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
  body { background: #0f1720; color: #f8fafc; }
  .card { background: linear-gradient(180deg,#111827 0%, #0b1220 100%); border-radius: 12px; border: 1px solid rgba(255,255,255,0.04); color: inherit; padding: 20px; }
  .form-section { padding: 18px; border-radius: 8px; background: rgba(255,255,255,0.02); margin-bottom: 18px; color: inherit; }
  canvas { border: 1px solid #ddd; background: #fff; display:block; touch-action:none; max-width: 100%; height: 140px; }
  .btn-clear { background: #dc3545; color: #fff; border:0; }
  .small-muted { color: #cbd5e1; font-size: .9rem; }
  .valor-alert { border-color: #dc3545 !important; background-color: #5c1212 !important; color: #fff !important; }
  label, .form-label { color: #f1f5f9; }
  .form-control, .form-select, textarea.form-control {
    background-color: #fff;
    color: #0b1220;
  }
  a, .btn { color: #f8fafc; }
  /* Novo estilo para botão e busca cliente */
  #btnMostrarBuscaCliente {
    display: block;
    margin: 0 auto 20px auto;
  }
  #secBuscaCliente {
    display: none;
    margin-bottom: 20px;
  }
</style>
</head>
<body class="container py-4">
  <div>
    <button type="button" id="btnMostrarBuscaCliente" class="btn btn-outline-light">Já é cliente? Clique aqui!</button>
  </div>

  <div id="secBuscaCliente" class="card">
    <label for="clienteBusca" class="form-label">Buscar Cliente (nome / CPF / telefone)</label>
    <input type="text" id="clienteBusca" name="clienteBusca" class="form-control" placeholder="Comece a digitar..." />
  </div>

  <div class="card">
    <h1 class="mb-3">Ficha de Anamnese</h1>
    <p class="small-muted">Preencha os dados abaixo — campos com * são obrigatórios.</p>

    <form id="anamneseForm" action="salvar_anamnese.php" method="POST" autocomplete="off" novalidate>
      <!-- Dados Pessoais -->
      <div class="form-section">
        <h5>Dados Pessoais</h5>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nome Completo *</label>
            <input type="text" name="nome" id="nome" class="form-control" required />
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">CPF</label>
            <input type="text" name="cpf" id="cpf" class="form-control" />
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Telefone / WhatsApp *</label>
            <input type="text" name="telefone" id="telefone" class="form-control" required />
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-5">
            <label class="form-label">Rua</label>
            <input type="text" name="endereco_rua" id="endereco_rua" class="form-control" />
          </div>
          <div class="col-md-2">
            <label class="form-label">Número</label>
            <input type="text" name="endereco_numero" id="endereco_numero" class="form-control" />
          </div>
          <div class="col-md-5">
            <label class="form-label">Bairro</label>
            <input type="text" name="endereco_bairro" id="endereco_bairro" class="form-control" />
          </div>
          <div class="col-md-5">
            <label class="form-label">Cidade</label>
            <input type="text" name="endereco_cidade" id="endereco_cidade" class="form-control" />
          </div>
          <div class="col-md-2">
            <label class="form-label">CEP</label>
            <input type="text" name="endereco_cep" id="endereco_cep" class="form-control" />
          </div>
          <div class="col-md-1">
            <label class="form-label">UF</label>
            <input type="text" name="endereco_uf" id="endereco_uf" maxlength="2" class="form-control text-uppercase" />
          </div>
        </div>

        <div class="mb-3 mt-3">
          <label class="form-label">Data de Nascimento</label>
          <input type="date" name="data_nascimento" id="data_nascimento" class="form-control" />
        </div>
      </div>

      <!-- Atendimento -->
      <div class="form-section">
        <h5>Atendimento</h5>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Unidade *</label>
            <select name="unidade" id="unidade" class="form-select" required>
              <option value="">Selecione...</option>
              <option value="Guarulhos">Guarulhos</option>
              <option value="São Bernardo do Campo">São Bernardo do Campo</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Tatuador *</label>
            <select name="tatuador" id="tatuador" class="form-select" required>
              <option value="">Selecione...</option>
              <option>Daniel</option>
              <option>Theo</option>
              <option>Meduri</option>
              <option>Wesley</option>
              <option>Will</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label for="valor" class="form-label">Valor acordado (R$) *</label>
            <input type="text" class="form-control" id="valor" name="valor" placeholder="Ex: 1500,00" required autocomplete="off" />
          </div>
        </div>

        <h5>Formas de pagamento</h5>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="pag_debito" class="form-label">Débito (R$)</label>
            <input type="text" class="form-control" id="pag_debito" name="pag_debito" placeholder="0,00" autocomplete="off" />
          </div>
          <div class="col-md-4">
            <label for="pag_credito_vista" class="form-label">Crédito à Vista (R$)</label>
            <input type="text" class="form-control" id="pag_credito_vista" name="pag_credito_vista" placeholder="0,00" autocomplete="off" />
          </div>
          <div class="col-md-2">
            <label for="pag_credito_parcelado_valor" class="form-label">Crédito Parcelado (R$)</label>
            <input type="text" class="form-control" id="pag_credito_parcelado_valor" name="pag_credito_parcelado_valor" placeholder="0,00" autocomplete="off" />
          </div>
          <div class="col-md-2">
            <label for="pag_credito_parcelado_vezes" class="form-label">Qtd. Parcelas</label>
            <input type="text" class="form-control" id="pag_credito_parcelado_vezes" name="pag_credito_parcelado_vezes" placeholder="0" autocomplete="off" />
          </div>
          <div class="col-md-4">
            <label for="pag_dinheiro" class="form-label">Dinheiro (R$)</label>
            <input type="text" class="form-control" id="pag_dinheiro" name="pag_dinheiro" placeholder="0,00" autocomplete="off" />
          </div>
          <div class="col-md-4">
            <label for="pag_pix" class="form-label">Pix (R$)</label>
            <input type="text" class="form-control" id="pag_pix" name="pag_pix" placeholder="0,00" autocomplete="off" />
          </div>
        </div>
      </div>

      <!-- Saúde -->
      <div class="form-section">
        <h5>Informações de Saúde</h5>
        <p class="small-muted">Esses dados são importantes para sua segurança.</p>

        <div class="mb-3">
          <label class="form-label">Está usando medicamentos?</label>
          <textarea name="medicamentos" id="medicamentos" class="form-control"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Possui alergias (tintas, látex, metais)?</label>
          <textarea name="alergias" id="alergias" class="form-control"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Doenças / Condições relevantes (hepatite, diabetes, cardiovasculares, etc)</label>
          <textarea name="saude" id="saude" class="form-control"></textarea>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Alergia a anestésicos?</label>
            <select name="alergia_anestesico" class="form-select">
              <option value="">Não informado</option>
              <option value="Sim">Sim</option>
              <option value="Não">Não</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Usa anticoagulante?</label>
            <select name="anticoagulante" class="form-select">
              <option value="">Não informado</option>
              <option value="Sim">Sim</option>
              <option value="Não">Não</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Tem tatuagens anteriores na área?</label>
            <select name="tatuagem_anterior" class="form-select">
              <option value="">Não informado</option>
              <option value="Sim">Sim</option>
              <option value="Não">Não</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Consentimentos -->
      <div class="form-section">
        <h5>Consentimentos</h5>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" name="lgpd" id="lgpd" required>
          <label class="form-check-label" for="lgpd">Concordo que meus dados serão registrados, e que a clínica seguirá a LGPD (não compartilharemos com terceiros).</label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" name="marketing" id="marketing">
          <label class="form-check-label" for="marketing">Aceito receber promoções pelo WhatsApp/email/telefone.</label>
        </div>
      </div>

      <!-- Assinatura -->
      <div class="form-section">
        <h5>Assinatura</h5>
        <p class="small-muted">Assine abaixo confirmando que as informações são verdadeiras.</p>
        <canvas id="assinatura" width="700" height="140"></canvas>
        <input type="hidden" name="assinaturaImagem" id="assinaturaImagem" />
        <div class="mt-2 d-flex gap-2">
          <button type="button" class="btn btn-clear" id="limparSig">Limpar</button>
          <button type="button" class="btn btn-secondary" id="preencherExemplo">Assinar Exemplo</button>
        </div>
      </div>

      <!-- Campos ocultos -->
      <input type="hidden" name="data_preenchimento" id="data_preenchimento" />

      <div class="d-flex justify-content-between align-items-center mt-3">
        <a href="listar_anamneses.php" class="btn btn-outline-light">Ver fichas salvas</a>
        <button type="submit" class="btn btn-primary btn-lg">Enviar Ficha</button>
      </div>
    </form>
  </div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
  // Toggle seção Buscar Cliente
  $('#btnMostrarBuscaCliente').on('click', function() {
    $('#secBuscaCliente').slideToggle();
  });

  // Data e hora atual
  document.getElementById('data_preenchimento').value = new Date().toLocaleString();

  // Máscaras
  $('#cpf').mask('000.000.000-00');
  $('#telefone').mask('(00) 00000-0000');
  $('#endereco_cep').mask('00000-000');
  $('#endereco_uf').on('input', function(){
    this.value = this.value.toUpperCase().replace(/[^A-Z]/g,'').slice(0,2);
  });

  $('#valor, #pag_debito, #pag_credito_vista, #pag_credito_parcelado_valor, #pag_dinheiro, #pag_pix').mask('#.##0,00', {reverse: true});
  $('#pag_credito_parcelado_vezes').mask('00', {reverse:false});

  // Validação valor combinado X formas de pagamento
  function parseValor(str) {
    if (!str) return 0;
    return parseFloat(str.replace(/\./g,'').replace(',', '.')) || 0;
  }

  function validarPagamento() {
    const valorTotal = parseValor($('#valor').val());
    const somaPagamentos = 
      parseValor($('#pag_debito').val()) +
      parseValor($('#pag_credito_vista').val()) +
      parseValor($('#pag_credito_parcelado_valor').val()) +
      parseValor($('#pag_dinheiro').val()) +
      parseValor($('#pag_pix').val());

    if (valorTotal === 0) {
      $('#valor').removeClass('valor-alert');
      return true;
    }

    if (valorTotal !== somaPagamentos) {
      $('#valor').addClass('valor-alert');
      return false;
    } else {
      $('#valor').removeClass('valor-alert');
      return true;
    }
  }

  $('#valor, #pag_debito, #pag_credito_vista, #pag_credito_parcelado_valor, #pag_dinheiro, #pag_pix').on('input', validarPagamento);

  // Assinatura canvas
  (function(){
    const canvas = document.getElementById('assinatura');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0;
    let lastY = 0;

    function resizeCanvas() {
      const ratio = window.devicePixelRatio || 1;
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      ctx.scale(ratio, ratio);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = 3;
      ctx.strokeStyle = '#000';
      clearCanvas();
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      $('#assinaturaImagem').val('');
    }

    function startDrawing(e) {
      drawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      lastY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      e.preventDefault();
    }

    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x;
      lastY = y;
      e.preventDefault();
    }

    function endDrawing(e) {
      drawing = false;
      // Save imagem base64 no hidden
      const dataURL = canvas.toDataURL('image/png');
      if (dataURL.length < 10000) { // muito pequena, possivelmente vazio
        $('#assinaturaImagem').val('');
      } else {
        $('#assinaturaImagem').val(dataURL);
      }
      e.preventDefault();
    }

    // Eventos
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('mouseup', endDrawing);
    canvas.addEventListener('touchend', endDrawing);
    canvas.addEventListener('touchcancel', endDrawing);

    // Botões
    $('#limparSig').click(clearCanvas);
    $('#preencherExemplo').click(function(){
      clearCanvas();
      ctx.font = '24px Arial';
      ctx.fillText('Assinatura Exemplo', 20, 90);
      $('#assinaturaImagem').val(canvas.toDataURL('image/png'));
    });

    // Inicializa
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
  })();

  // Autocomplete para buscar cliente e preencher campos
  $('#clienteBusca').autocomplete({
    source: 'clientes_autocomplete.php',
    minLength: 2,
    select: function(event, ui) {
      const d = ui.item.data;
      $('#nome').val(d.nome || '');
      $('#cpf').val(d.cpf || '');
      $('#telefone').val(d.telefone || '');
      $('#data_nascimento').val(d.data_nascimento || '');

      // Aqui corrigido para preencher os campos de endereço do jeito certo conforme seu JSON
      $('#endereco_rua').val(d.rua || '');
      $('#endereco_numero').val(d.numero || '');
      $('#endereco_bairro').val(d.bairro || '');
      $('#endereco_cidade').val(d.cidade || '');
      $('#endereco_cep').val(d.cep || '');
      $('#endereco_uf').val(d.estado || '');

      $('#secBuscaCliente').slideUp();
    }
  });
</script>
</body>
</html>
